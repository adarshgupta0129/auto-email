<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - User Statistics</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='15' fill='%23667eea'/><path d='M20 30h60v40H20z' fill='white'/><path d='M20 30l30 25 30-25' fill='none' stroke='%23667eea' stroke-width='4'/></svg>">
    <link rel="stylesheet" href="style.css">
</head>
<body class="app-page">
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="/" class="nav-logo">ðŸ“§ Auto Email</a>
            <div class="nav-links">
                <a href="/home.html" class="nav-link">Home</a>
                <a href="/" class="nav-link">Send Email</a>
                <a href="/inbox.html" class="nav-link">Inbox</a>
                <a href="/sent.html" class="nav-link">Sent</a>
            </div>
        </div>
    </nav>

    <div class="app-container">
        <div class="container admin-container">
            <h1>ðŸ‘‘ Admin Dashboard</h1>
            
            <!-- Access Denied -->
            <div id="accessDenied" class="login-section" style="display: none;">
                <p>â›” Access denied. This page is only for administrators.</p>
                <a href="/" class="btn btn-primary">Go to Home</a>
            </div>

            <!-- Admin Content -->
            <div id="adminContent" style="display: none;">
                <!-- Stats Summary -->
                <div class="stats-summary">
                    <div class="stat-card">
                        <div class="stat-number" id="totalUsers">0</div>
                        <div class="stat-label">Total Users</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="todayLogins">0</div>
                        <div class="stat-label">Today's Logins</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="weekLogins">0</div>
                        <div class="stat-label">This Week</div>
                    </div>
                </div>

                <!-- Users Table -->
                <div class="users-section">
                    <h2>ðŸ“‹ All Users</h2>
                    <div class="table-container">
                        <table class="users-table">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Email</th>
                                    <th>First Login</th>
                                    <th>Last Login</th>
                                    <th>Logins</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <tr><td colspan="5" class="loading">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer app-footer">
        <div class="footer-links">
            <a href="/home.html">Home</a>
            <a href="/privacy.html">Privacy Policy</a>
            <a href="/terms.html">Terms of Service</a>
        </div>
        <p>&copy; 2024 Auto Email Sender</p>
    </footer>

    <script>
        // Check admin access
        async function checkAdmin() {
            try {
                const response = await fetch('/api/admin/check');
                const data = await response.json();
                
                if (data.isAdmin) {
                    document.getElementById('adminContent').style.display = 'block';
                    document.getElementById('accessDenied').style.display = 'none';
                    loadUsers();
                } else {
                    document.getElementById('adminContent').style.display = 'none';
                    document.getElementById('accessDenied').style.display = 'block';
                }
            } catch (error) {
                document.getElementById('accessDenied').style.display = 'block';
            }
        }

        // Load users
        async function loadUsers() {
            try {
                const response = await fetch('/api/admin/users');
                const data = await response.json();
                
                if (data.success) {
                    displayStats(data.users);
                    displayUsers(data.users);
                }
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        // Display stats
        function displayStats(users) {
            const now = new Date();
            const today = now.toDateString();
            const weekAgo = new Date(now - 7 * 24 * 60 * 60 * 1000);
            
            const todayLogins = users.filter(u => 
                new Date(u.lastLogin).toDateString() === today
            ).length;
            
            const weekLogins = users.filter(u => 
                new Date(u.lastLogin) >= weekAgo
            ).length;
            
            document.getElementById('totalUsers').textContent = users.length;
            document.getElementById('todayLogins').textContent = todayLogins;
            document.getElementById('weekLogins').textContent = weekLogins;
        }

        // Display users table
        function displayUsers(users) {
            const tbody = document.getElementById('usersTableBody');
            
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="no-data">No users yet</td></tr>';
                return;
            }
            
            tbody.innerHTML = users.map(user => `
                <tr>
                    <td class="user-cell">
                        <img src="${user.picture || ''}" alt="" class="user-avatar-small" 
                             onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><circle cx=%2250%22 cy=%2250%22 r=%2250%22 fill=%22%23667eea%22/><text x=%2250%22 y=%2265%22 font-size=%2240%22 text-anchor=%22middle%22 fill=%22white%22>${user.name ? user.name.charAt(0).toUpperCase() : 'U'}</text></svg>'">
                        <span>${escapeHtml(user.name || 'Unknown')}</span>
                    </td>
                    <td>${escapeHtml(user.email)}</td>
                    <td>${formatDate(user.firstLogin)}</td>
                    <td>${formatDate(user.lastLogin)}</td>
                    <td>${user.loginCount || 1}</td>
                </tr>
            `).join('');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Initialize
        checkAdmin();
    </script>
</body>
</html>