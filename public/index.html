<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Send Email - Auto Email Sender</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='15' fill='%23667eea'/><path d='M20 30h60v40H20z' fill='white'/><path d='M20 30l30 25 30-25' fill='none' stroke='%23667eea' stroke-width='4'/></svg>">
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/@zxing/library@latest"></script>
</head>
<body class="app-page">
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="/" class="nav-logo">üìß Auto Email</a>
            <div class="nav-links">
                <a href="/home.html" class="nav-link">Home</a>
                <a href="/" class="nav-link active">Send Email</a>
                <a href="/inbox.html" class="nav-link auth-only" style="display: none;">Inbox</a>
                <a href="/sent.html" class="nav-link auth-only" style="display: none;">Sent</a>
            </div>
        </div>
    </nav>

    <div class="container app-container">
        <h1>üìß Auto Email Sender</h1>
        
        <!-- Login Section -->
        <div id="loginSection" class="login-section">
            <p>Sign in with your Google account to send emails</p>
            <a href="/auth/google" class="google-btn">
                <svg viewBox="0 0 24 24" width="24" height="24" xmlns="http://www.w3.org/2000/svg">
                    <g transform="matrix(1, 0, 0, 1, 0, 0)">
                        <path fill="#EA4335" d="M12 5c1.617 0 3.082.573 4.235 1.5L19.5 3.25C17.457 1.25 14.862 0 12 0 7.392 0 3.397 2.6 1.386 6.41l3.913 3.04C6.227 6.85 8.87 5 12 5z"/>
                        <path fill="#4285F4" d="M23.896 12.265c0-.816-.066-1.636-.2-2.438H12v4.62h6.69c-.275 1.522-1.13 2.822-2.428 3.69l3.862 3c2.26-2.084 3.772-5.148 3.772-8.872z"/>
                        <path fill="#FBBC05" d="M5.3 14.55c-.266-.79-.42-1.64-.42-2.55s.154-1.76.42-2.55L1.386 6.41C.504 8.16 0 10.022 0 12s.504 3.84 1.386 5.59L5.3 14.55z"/>
                        <path fill="#34A853" d="M12 24c3.24 0 5.966-1.075 7.954-2.913l-3.862-3c-1.08.72-2.462 1.14-4.092 1.14-3.13 0-5.773-1.85-6.7-4.45L1.386 17.59C3.397 21.4 7.392 24 12 24z"/>
                    </g>
                </svg>
                Sign in with Google
            </a>
        </div>

        <!-- User Info Section -->
        <div id="userSection" class="user-section" style="display: none;">
            <div class="user-info">
                <img id="userPicture" src="" alt="Profile" class="user-avatar" referrerpolicy="no-referrer">
                <div class="user-details">
                    <span id="userName" class="user-name"></span>
                    <span id="userEmail" class="user-email"></span>
                </div>
                <a href="/auth/logout" class="logout-btn">Logout</a>
            </div>
        </div>

        <!-- Email Form -->
        <form id="emailForm" enctype="multipart/form-data" style="display: none;">
            <div class="form-group">
                <label for="to">To Email:</label>
                <div class="input-with-button">
                    <input type="email" id="to" name="to" placeholder="recipient@gmail.com" required>
                    <button type="button" id="scanBtn" class="scan-btn">üì∑ Scan</button>
                </div>
            </div>

            <div class="form-group">
                <label for="subject">Subject:</label>
                <div class="template-row">
                    <select id="subjectSelect" class="template-select">
                        <option value="">-- Select from template or type below --</option>
                    </select>
                    <button type="button" id="deleteSubjectBtn" class="delete-template-btn" title="Delete selected subject">‚úï</button>
                </div>
                <div class="input-with-add">
                    <input type="text" id="subject" name="subject" placeholder="Enter email subject" required>
                    <button type="button" id="addSubjectBtn" class="add-template-btn" title="Save as template">+</button>
                </div>
            </div>

            <div class="form-group">
                <label for="message">Message:</label>
                <div class="template-row">
                    <select id="messageSelect" class="template-select">
                        <option value="">-- Select from template or type below --</option>
                    </select>
                    <button type="button" id="deleteMessageBtn" class="delete-template-btn" title="Delete selected message">‚úï</button>
                </div>
                <div class="input-with-add">
                    <textarea id="message" name="message" rows="5" placeholder="Enter your message here..." required></textarea>
                    <button type="button" id="addMessageBtn" class="add-template-btn" title="Save as template">+</button>
                </div>
            </div>

            <div class="form-group">
                <label>Attach Files:</label>
                <input type="file" id="attachments" name="attachments" multiple>
                <small class="file-hint">Upload any file type (max 10MB each, multiple files allowed)</small>
                
                <label class="sub-label">Or select from saved files:</label>
                <div class="files-list" id="filesList">
                    <!-- Files will be loaded here -->
                </div>
            </div>

            <button type="submit" class="send-btn">üì§ Send Email</button>
        </form>

        <div id="status" class="status"></div>

        <!-- Camera Scanner Modal -->
        <div id="scannerModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>üì∑ Scan Email QR Code / Barcode</h2>
                    <button id="closeScanner" class="close-btn">&times;</button>
                </div>
                <div class="scanner-container">
                    <video id="video" playsinline></video>
                    <div class="scanner-overlay"></div>
                </div>
                <div class="scanner-controls">
                    <button id="captureBtn" class="capture-btn">üì∏ Capture & Read</button>
                    <p class="scanner-hint">Point camera at QR code or text containing email address</p>
                </div>
                <div id="scanResult" class="scan-result"></div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer app-footer">
        <div class="footer-links">
            <a href="/home.html">Home</a>
            <a href="/privacy.html">Privacy Policy</a>
            <a href="/terms.html">Terms of Service</a>
        </div>
        <p>&copy; 2024 Auto Email Sender</p>
    </footer>

    <script>
        // DOM Elements
        const emailForm = document.getElementById('emailForm');
        const loginSection = document.getElementById('loginSection');
        const userSection = document.getElementById('userSection');
        const scanBtn = document.getElementById('scanBtn');
        const scannerModal = document.getElementById('scannerModal');
        const closeScanner = document.getElementById('closeScanner');
        const video = document.getElementById('video');
        const captureBtn = document.getElementById('captureBtn');
        const toInput = document.getElementById('to');
        const statusDiv = document.getElementById('status');
        const filesList = document.getElementById('filesList');
        const subjectSelect = document.getElementById('subjectSelect');
        const subjectInput = document.getElementById('subject');
        const messageSelect = document.getElementById('messageSelect');
        const messageInput = document.getElementById('message');
        const addSubjectBtn = document.getElementById('addSubjectBtn');
        const deleteSubjectBtn = document.getElementById('deleteSubjectBtn');
        const addMessageBtn = document.getElementById('addMessageBtn');
        const deleteMessageBtn = document.getElementById('deleteMessageBtn');

        let stream = null;
        let codeReader = null;

        // Check login status on page load
        async function checkLoginStatus() {
            try {
                const response = await fetch('/auth/user');
                const data = await response.json();
                
                if (data.loggedIn) {
                    loginSection.style.display = 'none';
                    userSection.style.display = 'block';
                    emailForm.style.display = 'block';
                    
                    // Show auth-only nav links
                    document.querySelectorAll('.auth-only').forEach(el => {
                        el.style.display = 'inline';
                    });
                    
                    document.getElementById('userName').textContent = data.user.name;
                    document.getElementById('userEmail').textContent = data.user.email;
                    
                    const userPicture = document.getElementById('userPicture');
                    if (data.user.picture) {
                        userPicture.src = data.user.picture;
                        userPicture.onerror = function() {
                            this.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="%23667eea"/><text x="50" y="65" font-size="40" text-anchor="middle" fill="white">' + data.user.name.charAt(0).toUpperCase() + '</text></svg>';
                        };
                    } else {
                        userPicture.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="%23667eea"/><text x="50" y="65" font-size="40" text-anchor="middle" fill="white">' + data.user.name.charAt(0).toUpperCase() + '</text></svg>';
                    }
                    
                    // Load templates and files
                    loadFiles();
                    loadSubjects();
                    loadMessages();
                } else {
                    loginSection.style.display = 'block';
                    userSection.style.display = 'none';
                    emailForm.style.display = 'none';
                }
            } catch (error) {
                console.error('Error checking login status:', error);
            }
        }

        // Check for login result in URL
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('login') === 'success') {
            showStatus('Logged in successfully!', 'success');
            window.history.replaceState({}, document.title, '/');
        } else if (urlParams.get('login') === 'error') {
            showStatus('Login failed. Please try again.', 'error');
            window.history.replaceState({}, document.title, '/');
        }

        // Initialize
        checkLoginStatus();

        // Load saved files
        async function loadFiles() {
            try {
                const response = await fetch('/files');
                const data = await response.json();
                
                if (data.files.length === 0) {
                    filesList.innerHTML = '<p class="no-files">No saved files</p>';
                    return;
                }
                
                filesList.innerHTML = data.files.map(file => `
                    <div class="file-item">
                        <label class="file-checkbox">
                            <input type="checkbox" name="selectedFiles" value="${file}">
                            <span class="file-name">üìé ${file}</span>
                        </label>
                        <button type="button" class="delete-file-btn" data-file="${file}" title="Delete file">‚úï</button>
                    </div>
                `).join('');
                
                document.querySelectorAll('.delete-file-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const fileName = e.target.dataset.file;
                        if (confirm(`Delete file: "${fileName}"?`)) {
                            await deleteFile(fileName);
                        }
                    });
                });
            } catch (error) {
                console.error('Error loading files:', error);
            }
        }

        async function deleteFile(fileName) {
            try {
                const response = await fetch('/files/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ fileName })
                });
                const result = await response.json();
                if (result.success) {
                    showStatus('File deleted!', 'success');
                    loadFiles();
                } else {
                    showStatus('Error deleting file', 'error');
                }
            } catch (error) {
                showStatus('Error deleting file', 'error');
            }
        }

        async function loadSubjects() {
            try {
                const response = await fetch('/templates/subjects');
                const data = await response.json();
                subjectSelect.innerHTML = '<option value="">-- Select from template or type below --</option>';
                data.subjects.forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject;
                    option.textContent = subject;
                    subjectSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading subjects:', error);
            }
        }

        async function loadMessages() {
            try {
                const response = await fetch('/templates/messages');
                const data = await response.json();
                messageSelect.innerHTML = '<option value="">-- Select from template or type below --</option>';
                data.messages.forEach((message, index) => {
                    const option = document.createElement('option');
                    option.value = message;
                    option.textContent = `Template ${index + 1}: ${message.substring(0, 50)}...`;
                    messageSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }

        subjectSelect.addEventListener('change', () => {
            if (subjectSelect.value) {
                subjectInput.value = subjectSelect.value;
            }
        });

        messageSelect.addEventListener('change', () => {
            if (messageSelect.value) {
                messageInput.value = messageSelect.value;
            }
        });

        deleteSubjectBtn.addEventListener('click', async () => {
            const selectedSubject = subjectSelect.value;
            if (!selectedSubject) {
                showStatus('Please select a subject to delete', 'error');
                return;
            }
            
            if (confirm(`Delete subject: "${selectedSubject}"?`)) {
                try {
                    const response = await fetch('/templates/subjects/delete', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ subject: selectedSubject })
                    });
                    const result = await response.json();
                    if (result.success) {
                        showStatus('Subject deleted!', 'success');
                        loadSubjects();
                        subjectInput.value = '';
                    }
                } catch (error) {
                    showStatus('Error deleting subject', 'error');
                }
            }
        });

        deleteMessageBtn.addEventListener('click', async () => {
            const selectedMessage = messageSelect.value;
            if (!selectedMessage) {
                showStatus('Please select a message to delete', 'error');
                return;
            }
            
            if (confirm('Delete this message template?')) {
                try {
                    const response = await fetch('/templates/messages/delete', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: selectedMessage })
                    });
                    const result = await response.json();
                    if (result.success) {
                        showStatus('Message deleted!', 'success');
                        loadMessages();
                        messageInput.value = '';
                    }
                } catch (error) {
                    showStatus('Error deleting message', 'error');
                }
            }
        });

        addSubjectBtn.addEventListener('click', async () => {
            const subject = subjectInput.value.trim();
            if (!subject) {
                showStatus('Please enter a subject first', 'error');
                return;
            }
            try {
                await fetch('/templates/subjects/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ subject })
                });
                showStatus('Subject saved as template!', 'success');
                loadSubjects();
            } catch (error) {
                showStatus('Error saving subject', 'error');
            }
        });

        addMessageBtn.addEventListener('click', async () => {
            const message = messageInput.value.trim();
            if (!message) {
                showStatus('Please enter a message first', 'error');
                return;
            }
            try {
                await fetch('/templates/messages/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });
                showStatus('Message saved as template!', 'success');
                loadMessages();
            } catch (error) {
                showStatus('Error saving message', 'error');
            }
        });

        // Scanner functionality
        scanBtn.addEventListener('click', async () => {
            scannerModal.style.display = 'flex';
            await startCamera();
        });

        closeScanner.addEventListener('click', () => {
            stopCamera();
            scannerModal.style.display = 'none';
        });

        scannerModal.addEventListener('click', (e) => {
            if (e.target === scannerModal) {
                stopCamera();
                scannerModal.style.display = 'none';
            }
        });

        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }
                });
                video.srcObject = stream;
                await video.play();

                codeReader = new ZXing.BrowserMultiFormatReader();
                
                codeReader.decodeFromVideoDevice(null, 'video', (result, err) => {
                    if (result) {
                        const text = result.getText();
                        const email = extractEmail(text);
                        if (email) {
                            scanResult.innerHTML = `<span class="success">‚úÖ Found: ${email}</span>`;
                            toInput.value = email;
                            setTimeout(() => {
                                stopCamera();
                                scannerModal.style.display = 'none';
                                showStatus('Email scanned successfully!', 'success');
                            }, 1000);
                        }
                    }
                });

            } catch (error) {
                console.error('Error accessing camera:', error);
                scanResult.innerHTML = `<span class="error">‚ùå Camera error: ${error.message}</span>`;
            }
        }

        function stopCamera() {
            if (codeReader) {
                codeReader.reset();
                codeReader = null;
            }
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            video.srcObject = null;
            scanResult.innerHTML = '';
        }

        function extractEmail(text) {
            const emailRegex = /[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/g;
            const matches = text.match(emailRegex);
            return matches ? matches[0] : null;
        }

        captureBtn.addEventListener('click', () => {
            if (!video.srcObject) return;
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);
            if (codeReader) {
                scanResult.innerHTML = '<span class="info">üîç Scanning...</span>';
            }
        });

        // Form submission
        emailForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData();
            formData.append('to', document.getElementById('to').value);
            formData.append('subject', document.getElementById('subject').value);
            formData.append('message', document.getElementById('message').value);

            const attachmentFiles = document.getElementById('attachments').files;
            for (let i = 0; i < attachmentFiles.length; i++) {
                formData.append('attachments', attachmentFiles[i]);
            }

            const selectedFiles = document.querySelectorAll('input[name="selectedFiles"]:checked');
            selectedFiles.forEach(checkbox => {
                formData.append('selectedFiles', checkbox.value);
            });

            showStatus('Sending email...', 'info');

            try {
                const response = await fetch('/send-email', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    showStatus(result.message, 'success');
                    emailForm.reset();
                    loadFiles();
                } else {
                    showStatus(result.message, 'error');
                }
            } catch (error) {
                showStatus('Error: ' + error.message, 'error');
            }
        });

        function showStatus(message, type) {
            statusDiv.textContent = message;
            statusDiv.className = 'status ' + type;
            statusDiv.style.display = 'block';

            if (type === 'success') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        }
    </script>
</body>
</html>
